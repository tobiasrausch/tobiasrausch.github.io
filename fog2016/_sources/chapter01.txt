Structural Variant Analysis using Simulated Data
================================================


Getting Started
---------------
As a quick introduction we will do a structural variant analysis of the simulated data provided by the ICGC-TCGA DREAM Mutation Calling challenge [Dream]_. The data has been further down-sampled to speed up all analyses discussed hereafter. The entire data can be downloaded from Google Drive using this URL 'https://drive.google.com/file/d/0BzeE4HZ6nt-KMDV2d0s2N1pZQkE/view?usp=sharing'.


Alignment
---------

The simulated data has already been aligned to chr20 of hg19. The chr20 reference FASTA file is called '20.fa'. There is one bam file [Bam]_ for the tumor (file tumor20.bam) and one for the matched normal (file normal20.bam). Using samtools [Li2009]_ we can have a look at the first few records.

.. code-block:: bash

   samtools view $DS/tumor20.bam | head


If you haven't done so yet please familiarize yourself with the bam format, the required fields present in every bam alignment record are explained below:

   =======  ==========  =====================================
   **Col**  **Field**   **Description**
   -------  ----------  -------------------------------------
   1        QNAME       Query template NAME
   2        FLAG        bitwise FLAG
   3        RNAME       Reference sequence NAME
   4        POS         1-based leftmost mapping POSition
   5        MAPQ        MAPping Quality
   6        CIGAR       CIGAR string
   7        RNEXT       Ref. name of the mate/next read
   8        PNEXT       Position of the mate/next read
   9        TLEN        observed Template LENgth
   10       SEQ         segment SEQuence
   11       QUAL        ASCII of Phred-scaled base QUALity+33
   =======  ==========  =====================================

The bitwise FLAG can be decoded using the explain flag tool from the picard distribution [ExplainFlag]_.

Usually one would first evaluate the quality of the sequencing data using tools such as FASTQC [FastQC]_ but since this is simulated data we will skip this step. Other useful tools for NGS quality control are picard [Picard]_ and samtools [Samtools]_.

Delly [Rausch2012]_ uses paired-end mapping to discover structural variants and the method can handle paired-ends from different libraries as long as these have been tagged with unique read-groups (@RG tags). These read-groups are listed in the bam header.

.. code-block:: bash

   samtools view -H $DS/tumor20.bam 


Structural Variant Discovery using Delly
----------------------------------------

Since this is simulated data we will skip the alignment quality control and move on directly to the structural variant calling. Delly [Rausch2012]_ calls structural variants jointly on the tumor and normal genome and outputs a VCF (variant-call-format) file. The VCF specification can be found on the VCFtools website [VCFtools]_. The ICGC-TCGA DREAM Mutation Calling challenge simulated only deletions, duplications and inversions so we will skip the translocation prediction. Besides the bam files, you can provide a reference genome which then triggers the split-read search of Delly. You can also provide a text file with regions to exclude from the analysis of structural variants. The default exclude map of Delly includes the telomeric and centromeric regions of all human chromosomes since these regions cannot be accurately analyzed with short-read data.

.. code-block:: bash

   $DE/src/delly -t DEL -g $DS/20.fa -x $DS/hg19.ex -o del.vcf $DS/tumor20.bam $DS/normal20.bam
   $DE/src/delly -t DUP -g $DS/20.fa -x $DS/hg19.ex -o dup.vcf $DS/tumor20.bam $DS/normal20.bam
   $DE/src/delly -t INV -g $DS/20.fa -x $DS/hg19.ex -o inv.vcf $DS/tumor20.bam $DS/normal20.bam

A vcf file [VCFtools]_ has multiple header lines starting with the hash # sign. Below the header lines is one record for each structural variant. The record format is described in the below table:

   =======  ==========  ===================================================================================
   **Col**  **Field**   **Description**
   -------  ----------  -----------------------------------------------------------------------------------
   1        CHROM       Chromosome name
   2        POS         1-based position. For an indel, this is the position preceding the indel.
   3        ID          Variant identifier. Usually the dbSNP rsID.
   4        REF         Reference sequence at POS involved in the variant. For a SNP, it is a single base.
   5        ALT         Comma delimited list of alternative sequence(s).
   6        QUAL        Phred-scaled probability of all samples being homozygous reference.
   7        FILTER      Semicolon delimited list of filters that the variant fails to pass.
   8        INFO        Semicolon delimited list of variant information.
   9        FORMAT      Colon delimited list of the format of individual genotypes in the following fields.
   10+      Samples     Individual genotype information defined by FORMAT.
   =======  ==========  ===================================================================================

You can look at the header of the vcf file using grep, '-A 1' includes the first structural variant record in the file:

.. code-block:: bash

   grep "^#" -A 1 inv.vcf

In general, Delly uses the VCF:INFO fields for structural variant site information, such as how confident the structural variant prediction is and how accurate the breakpoints are. The genotype fields contain the actual sample genotype, its genotype quality and genotype likelihoods and various count fields for the variant and reference supporting reads and spanning pairs. If you browse through the vcf file you will notice that a subset of the Delly structural variant predictions have been refined using split-reads. These precise variants are flagged in the vcf info field with the tag 'PRECISE'. To count the number of precise and imprecise variants you can simply use grep.

.. code-block:: bash

   grep -c -w "PRECISE" *.vcf
   grep -c -w "IMPRECISE" *.vcf

Please note that this vcf file contains germline and somatic structural variants but also false positives caused by repeat-induced mis-mappings or incomplete reference sequences. As a final step we have to use the structural variant site information and the tumor and normal genotype information to filter a set of confident somatic structural variants.



Somatic Structural Variant Filtering
------------------------------------

Delly ships with a somatic filtering python script. For a set of confident somatic calls one could exclude all structural variants <400bp, require a minimum variant allele frequency of 10%, no support in the matched normal and an overall confident structural variant site prediction with the VCF filter field being equal to PASS.

.. code-block:: bash

   python $SF -t DEL -v del.vcf -o del.filt.vcf -a 0.1 -m 400 -f
   python $SF -t DUP -v dup.vcf -o dup.filt.vcf -a 0.1 -m 400 -f
   python $SF -t INV -v inv.vcf -o inv.filt.vcf -a 0.1 -m 400 -f

Using VCFtools [VCFtools]_ we can merge all somatic structural variants together in a single vcf file.

.. code-block:: bash

   vcf-concat del.filt.vcf dup.filt.vcf inv.filt.vcf  | vcf-sort > somatic.sv.vcf
   vcf-validator somatic.sv.vcf

For large VCF files you should also zip and index them using bgzip and tabix.

.. code-block:: bash

   bgzip somatic.sv.vcf 
   tabix somatic.sv.vcf.gz

The final step will be to browse some of these somatic structural variants in IGV [IGV]_. To make that easier we will also create a bed file with the start and end coordinates of each structural variant. This vcf2bed conversion is a bit ugly because VCF was designed for single-nucleotide variants, so I wrote a small shell script to do this conversion, called 'vcf2Bed.sh'.

.. code-block:: bash

   $DE/converter/dellyVcf2Bed.sh somatic.sv.vcf.gz > somatic.sv.bed
   head somatic.sv.bed

We then start IGV using the chr20 reference.

.. code-block:: bash

   igv.sh -g $DS/20.fa


Once IGV has started use 'File' and 'Load from File' to load the tumor and normal bam alignment file. Then import 'somatic.sv.bed' from your working directory using 'Regions' and 'Import Regions'. The somatic structural variants can then be browsed easily using 'Regions' and 'Region Navigator'. Select a structural variant in the Region Navigator and click 'View', which will center the IGV alignment view on the selected structural variant. It's usually best to zoom out once then by clicking on the '-' sign in the toolbar at the top, so you can view all supporting abnormal paired-ends. To highlight the abnormal paired-ends please right click in IGV on tumor20.bam and activate 'View as pairs'. In the same menu, please open 'Color alignments by' and then switch to "pair orientation', afterwards repeat these steps for normal20.bam. For deletions, you can also color the alignments by "insert size". You can obviously play around with all the different visualization options but the above two are what I found most useful for a discordant paired-end analysis. Using the Region Navigator you can easily iterate now through the predicted, somatic SVs.


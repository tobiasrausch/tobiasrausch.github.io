Alignment & Data Quality Control
================================


Getting Started
---------------
The course data is from a rare disease sample that was recently sequenced at EMBL Genecore using a DNA whole-exome capture protocol and an illumina sequencer.
The data has been down-sampled and reduced to a single chromosome (chr7) to speed up all analyses discussed hereafter. Please do not copy or redistribute the data anywhere
outside this course. Since all course participants will do the exercises simultaneously please copy the data to your local hard drive using: 

.. code-block:: bash

   mkdir <your_name>
   cd <your_name>
   tar -xzf /EMBL/scrap/rausch/ngs2014.tar.gz
   cd ngs2014/

For VCFtools [VCFtools]_ we also need to set the Perl library path.

.. code-block:: bash

   export PERL5LIB=`pwd`/bin/vcftools_0.1.12a/perl/
   export PI=/g/teachinglab/bin/

If you encounter any errors or typos in this handout please write me an email [Rausch]_.


Fastq QC
--------

Before starting to map the data one should inspect the quality of the reads in fastq format [Fastq]_ using tools such as fastqc [Fastqc]_. 
Fastqc highlights adapter contamination, PCR duplicates and problems with the base distribution and base qualities.

.. code-block:: bash

   fastqc --noextract r1.fq.gz
   unzip r1_fastqc.zip
   firefox r1_fastqc/fastqc_report.html

   fastqc --noextract r2.fq.gz
   unzip r2_fastqc.zip
   firefox r2_fastqc/fastqc_report.html

If some of the plots are unclear please have a look at the Fastqc documentation [FastqcDoc]_.


Alignment
---------

BWA [Li2009a]_ is a commonly used read mapper. The reference has to be indexed once before it can be used for read alignment:

.. code-block:: bash

   bwa index -a bwtsw chr7.fa

Next the paired-end fastq files can be aligned against the index:

.. code-block:: bash

   bwa mem chr7.fa r1.fq.gz r2.fq.gz | samtools view -bT chr7.fa - > align.bam

The alignment will run for about 5 minutes. While the alignment is running you can already have a look at the first records of the bam file [Bam]_ and familiarize yourself with the bam format:

.. code-block:: bash

   samtools view align.bam | head

The different required fields present in a bam alignment record are explained below:

   =======  ==========  =====================================
   **Col**  **Field**   **Description**
   -------  ----------  -------------------------------------
   1        QNAME       Query template NAME
   2        FLAG        bitwise FLAG
   3        RNAME       Reference sequence NAME
   4        POS         1-based leftmost mapping POSition
   5        MAPQ        MAPping Quality
   6        CIGAR       CIGAR string
   7        RNEXT       Ref. name of the mate/next read
   8        PNEXT       Position of the mate/next read
   9        TLEN        observed Template LENgth
   10       SEQ         segment SEQuence
   11       QUAL        ASCII of Phred-scaled base QUALity+33
   =======  ==========  =====================================

Once the alignment is finished please sort the bam file by coordinate using samtools [Li2009b]_:

.. code-block:: bash

   samtools sort align.bam align.sort

The sorted file now needs to be indexed so that alignment viewers can efficiently access a certain alignment window.

.. code-block:: bash

   samtools index align.sort.bam


Alignment QC
------------

The quality of the final alignment should be checked prior to any variant calling. There are some simple statistics such as the insert size distribution, the gc bias and the percentage of mapped reads, singletons, duplicates and properly paired reads that can highlight quite a number of typical sequencing problems. Overall it's usually worth spending the extra time running these quality control tools. The picard [Picard]_ and samtools [Samtools]_ library provide some excellent tools to compute these simple alignment statistics.

.. code-block:: bash

   samtools flagstat align.sort.bam
   java -jar ${PI}/CollectGcBiasMetrics.jar I=align.sort.bam O=gc.txt R=chr7.fa CHART=gc.pdf AS=true
   evince gc.pdf

Please read the on-line documentation for these tools to get an explanation of the different metrics [PicardDoc]_. There are some general rules how a good alignment should look like, e.g. a heavy gc bias, mapping percentages below 70% or very high duplicate rates are clearly warning signals. However, these statistics vary largely by protocol and hence, it's usually best to compare multiple different sequencing runs using the same protocol (DNA-seq, RNA-seq, ChIP-seq, paired-end, single-end or mate-pair protocol, etc.) against each other, which then highlights the outliers. 
